Bug fixies and performance improvement